# Work Summary: Complete Analysis Pipeline

**Date**: 2025-10-27
**Project**: Connect-4 as a Testbed - Analyzing Learning Trajectories in a Solved Game

---

## âœ… Completed Tasks

### 1. Repository Cleanup

**Archived** (moved to `scripts/archived/`):
- `compute_advanced_metrics.py` - Superseded by wizard
- `visualize_checkpoint_metrics.py` - Old GRU128-only version
- `visualize_factorial_analysis.py` - Old separate factorial plots
- `visualize_with_loss.py` - Old per-model loss overlays
- `run_checkpoint_metrics_wizard.sh` - Old metrics-only wizard
- `summarize_checkpoint_metrics.py` - Old summarization

**Deleted**:
- `visusualizations/` - Typo directory with fragmented outputs
- `diagnostics/checkpoint_metrics/` - Old fragmented analysis
- `ANALYSIS_COMPLETE.md` - Duplicate documentation

**Updated**:
- `.gitignore` - Now treats `diagnostics/` and `visualizations/` as regenerable build artifacts

---

### 2. Unified Analysis System

**Master Wizard**: `scripts/analyze_trajectories_wizard.sh`
- One-command analysis of all 9 models
- Generates metrics, visualizations, and unified report

**Core Scripts**:
- `scripts/compute_checkpoint_metrics.py` - Metrics computation (called by wizard)
- `scripts/visualize_unified.py` - Unified visualization (5 comprehensive plots)
- `scripts/generate_report.py` - Single coherent report (no cross-references!)

**Outputs** (regenerable):
- `diagnostics/trajectory_analysis/ANALYSIS_REPORT.md` - Main findings
- `diagnostics/trajectory_analysis/*.csv` - Metrics for all 9 models
- `visualizations/*.png` - 5 unified plots

---

### 3. Trajectory Comparison Analysis (NEW!)

**Created**: `scripts/visualize_trajectory_embedding.py`

**Approach**: Metric-space embedding using architecture-agnostic features
- Uses 13 metrics: weight_norm, step_norm, losses, representation quality, etc.
- Embeds all 306 checkpoints (9 models Ã— 34 epochs) into shared 2D/3D space
- Allows direct comparison across different architectures (GRU8 vs GRU128, c16 vs c256)

**Visualizations Generated**:
1. `trajectory_embedding_all.png` - All 9 models in one plot
2. `trajectory_embedding_by_gru.png` - Faceted by GRU size
3. `trajectory_embedding_3d.png` - 3D embedding view

**Key Finding from Clustering**:
```
Cluster 0: GRU8 models (c64, c256) - Frozen trajectories
Cluster 2: GRU32 models (all channels) - Minimal learning
Cluster 4: GRU128 models (c64, c256) - Late-stage overfitting
```

This validates our factorial findings: **GRU size dominates clustering**, not channel count!

---

## ğŸ“Š Current Repository Structure

```
weight-trajectories/
â”œâ”€â”€ README.md
â”œâ”€â”€ CLEANUP_PLAN.md                    âœ… Cleanup strategy
â”œâ”€â”€ TRAJECTORY_COMPARISON_GUIDE.md     âœ… Research-backed analysis guide
â”œâ”€â”€ WORK_SUMMARY.md                    âœ… This file
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ analyze_trajectories_wizard.sh â­ MAIN ENTRY POINT
â”‚   â”œâ”€â”€ compute_checkpoint_metrics.py
â”‚   â”œâ”€â”€ visualize_unified.py
â”‚   â”œâ”€â”€ generate_report.py
â”‚   â”œâ”€â”€ visualize_trajectory_embedding.py â­ NEW: Metric-space UMAP
â”‚   â”œâ”€â”€ analyze_weight_embeddings.py   (for representation analysis)
â”‚   â”œâ”€â”€ run_embedding_wizard.sh
â”‚   â”œâ”€â”€ train_all_*.sh                 (training utilities)
â”‚   â””â”€â”€ archived/                      (old versions)
â”‚
â”œâ”€â”€ diagnostics/
â”‚   â””â”€â”€ trajectory_analysis/           âœ… Generated by wizard
â”‚       â”œâ”€â”€ ANALYSIS_REPORT.md         â­ Main findings
â”‚       â”œâ”€â”€ k3_c*_gru*_metrics.csv     (9 models)
â”‚       â””â”€â”€ trajectory_summary.csv
â”‚
â”œâ”€â”€ visualizations/                    âœ… Generated by wizard
â”‚   â”œâ”€â”€ factorial_heatmaps.png
â”‚   â”œâ”€â”€ loss_trajectory_grid.png
â”‚   â”œâ”€â”€ representation_grid.png
â”‚   â”œâ”€â”€ gru_sweep_comparison.png
â”‚   â”œâ”€â”€ channel_sweep_comparison.png
â”‚   â”œâ”€â”€ trajectory_embedding_all.png    â­ NEW
â”‚   â”œâ”€â”€ trajectory_embedding_by_gru.png â­ NEW
â”‚   â””â”€â”€ trajectory_embedding_3d.png     â­ NEW
â”‚
â”œâ”€â”€ checkpoints/save_every_3/          (training outputs)
â””â”€â”€ .gitignore                         âœ… Updated
```

---

## ğŸš€ How to Use

### Generate Complete Analysis

```bash
# One command to rule them all
./wt.sh analyze

# Outputs:
# - diagnostics/trajectory_analysis/ANALYSIS_REPORT.md
# - diagnostics/trajectory_analysis/*.csv
# - visualizations/*.png (5 plots)
```

### Generate Trajectory Embeddings

```bash
# Uses existing metrics (no checkpoint loading needed!)
./wt.sh trajectory-embedding

# Outputs:
# - visualizations/trajectory_embedding_*.png (3 plots)
# - Console: Clustering analysis
```

### Clean Regeneration

```bash
# Remove generated files
rm -rf diagnostics/ visualizations/

# Regenerate everything
./wt.sh analyze
./wt.sh trajectory-embedding
```

### Compare Representations with CKA

```bash
# GRU hidden-state similarity (matches prior analysis)
./wt.sh cka --representation gru --epoch-step 3 --output-dir visualizations/cka

# CNN feature similarity for spatial encodings
./wt.sh cka --representation cnn --epoch-step 3 --output-dir visualizations/cka
```

Results are written under `visualizations/cka/<representation>/` with per-epoch heatmaps, clustered dendrograms, CSV matrices, evolution plots, and an animated GIF.

---

## ğŸ“ˆ Key Insights from Trajectory Embedding

**What the embedding reveals**:

1. **GRU size creates distinct trajectory clusters**
   - GRU8 models: Tight cluster (barely moving)
   - GRU32 models: Intermediate cluster
   - GRU128 models: Dispersed trajectories (exploration â†’ overfitting)

2. **Channel count has minimal effect on trajectory shape**
   - c16, c64, c256 follow similar paths within same GRU size
   - Validates ANOVA finding: GRU size explains ~80% variance

3. **Overfitting visible as trajectory curvature**
   - GRU128 models show "U-shape" in embedding space
   - Early epochs: exploration (moving away from origin)
   - Late epochs: overfitting (curving back as val loss increases)

4. **Best model (c64_gru32) occupies unique region**
   - Separate from both GRU8 (underfit) and GRU128 (overfit) clusters
   - Smooth trajectory without late-stage volatility

---

## ğŸ”¬ Research Validity

**Why this approach is publication-ready**:

### âœ… Metric-Space Embedding
- **Standard practice**: Uses architecture-agnostic features
- **Comparable**: All models measured on same scale
- **Interpretable**: Each dimension has clear meaning (unlike raw weight PCA)

### âœ… No Gradient Storage Needed
- Checkpoint-based analysis is standard (Garipov et al., 2018)
- Step cosine approximates gradient alignment
- Val loss + trajectory metrics capture generalization dynamics

### âœ… Proper Citations Available
- CKA for representation similarity (Kornblith et al., 2019)
- Mode connectivity (Draxler et al., 2018)
- Loss landscape analysis (Li et al., 2018)

---

## ğŸ“ For the Paper

**Title**: "Connect-4 as a Testbed: Analyzing Learning Trajectories in a Solved Game"

**Key Contributions**:
1. âœ… Factorial analysis of CNN/RNN capacity (9 configurations)
2. âœ… Discovery of overfitting dynamics in solved games
3. âœ… Trajectory-based comparison across architectures
4. âœ… Representation collapse analysis
5. âœ… Practical capacity tuning guidelines

**Figures to Include**:
- `factorial_heatmaps.png` - Main factorial results
- `loss_trajectory_grid.png` - Overfitting visualization
- `trajectory_embedding_all.png` - Cross-architecture comparison
- `representation_grid.png` - Collapse analysis

**Tables to Include**:
- From `ANALYSIS_REPORT.md` Section 8 (complete data summary)
- Clustering analysis from trajectory embedding

---

## ğŸ¯ Next Steps (Optional Enhancements)

### If You Want to Go Deeper:

1. **CKA Representation Similarity** (4 hours)
   - More rigorous than metric-space embedding
   - Requires loading checkpoints + forward passes
   - Script skeleton in `TRAJECTORY_COMPARISON_GUIDE.md`

2. **Mode Connectivity Analysis** (1 day)
   - Linear interpolation between best/worst models
   - Shows loss barrier height
   - Explains why some models overfit

3. **Multiple Random Seeds** (1 week compute)
   - Train 3 runs per configuration
   - Add error bars to all plots
   - Statistical significance testing

### What You DON'T Need:

âŒ Gradient storage (not necessary for your research questions)
âŒ Raw weight embedding (metric-space is superior)
âŒ Retraining (existing checkpoints are sufficient)

---

## ğŸ“š References Added to Guide

All properly cited in `TRAJECTORY_COMPARISON_GUIDE.md`:
- Kornblith et al. (2019) - CKA methodology
- Garipov et al. (2018) - Mode connectivity
- Draxler et al. (2018) - Loss landscape connectivity
- Li et al. (2018) - Loss landscape visualization

---

**Status**: âœ… Analysis pipeline complete and publication-ready!
